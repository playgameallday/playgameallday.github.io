<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lost Pet Map</title>

<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<button onclick="loginGoogle()">Login ด้วย Google</button>
<button onclick="logout()">Logout</button>

<style>
  body { margin:0; font-family: system-ui, sans-serif; }
  #map { height:100vh; }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    z-index: 1000;

    /* เพิ่ม */
    padding: 12px;
    overflow-y: auto;   /* ⭐ กันล้นจอ */
  }

  .modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (max-width: 600px) {
    .modal-box {
      max-width: none;
      width: 100%;
      height: 100%;
      max-height: none;
      border-radius: 0;
    }
  }

  .field { margin-bottom:10px; }
  label { font-size:12px; color:#555; }
  input, select {
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
  }

  .actions { display:flex; gap:8px; margin-top:10px; }
  button {
    flex:1;
    padding:10px;
    border:none;
    border-radius:10px;
    cursor:pointer;
  }
  .save { background:#ff5b5b; color:#fff; }
  
  .pet-marker {
	border-radius: 50%;
	border: 3px solid;
	background: #fff;
  }

  .pet-marker.ตามหา-Lost {
	border-color: #ff4d4f; /* แดง */
  }

  .pet-marker.พบ-Found {
	border-color: #2ecc71; /* เขียว */
  }

  .popup {
    width: 300px;
  }

  .popup-img-wrap {
    width: 100%;
    height: 140px;        /* ปรับความสูงได้ */
    overflow: hidden;    /* ⭐ สำคัญมาก */
    border-radius: 12px;
    margin-bottom: 6px;
  }

  .popup-img {
    width: 100%;
    height: 100%;
    object-fit: cover;   /* ครอป ไม่ยืด */
    display: block;
  }
  
  
</style>
</head>

<body>
<div id="map"></div>

<!-- ===== Modal ===== -->
<div class="modal" id="petModal">
  <div class="modal-box">
    <h2>เพิ่มสัตว์เลี้ยง</h2>

    <div class="field">
      <label>สถานะ</label>
      <select id="type">
        <option value="ตามหา-Lost">ตามหา</option>
        <option value="พบ-Found">พบ</option>
      </select>
    </div>

    <div class="field">
      <label>สัตว์</label>
      <select id="animal" onchange="toggleOtherAnimal()">
        <option value="สุนัข(Dog)">สุนัข</option>
        <option value="แมว(Cat)">แมว</option>
        <option value="อื่นๆ(Other)">อื่นๆ</option>
      </select>
    </div>

    <div class="field" id="otherAnimalField" style="display:none">
      <label>ระบุชนิดสัตว์</label>
      <input id="otherAnimal" placeholder="เช่น นก / กระต่าย / เต่า">
    </div>

	<div class="field">
      <label>ชื่อสัตว์</label>
      <input id="petName" placeholder="เช่น โบโบ้ / มะลิ">
    </div>

    <div class="field">
      <label>สายพันธุ์</label>
      <input id="breed" placeholder="เช่น ไทยผสม">
    </div>

    <div class="field">
      <label>สี</label>
      <input id="color" placeholder="ขาว / ดำ / น้ำตาล">
    </div>

    <div class="field">
      <label>วันที่</label>
      <input type="date" id="date">
    </div>

    <div class="field">
      <label>ติดต่อ</label>
      <input id="contact" placeholder="เบอร์โทร / LINE">
    </div>

    <div class="field">
	  <label>รูปสัตว์</label>
	  <input type="file" id="imageFile" accept="image/jpeg, image/png">
	</div>
	
	<div class="field">
	  <label>ข้อมูลเพิ่มเติม</label>
	  <input id="animalDetail" placeholder="รายละเอียดเพิ่มเติม">
	</div>

    <div class="actions">
      <button class="cancel" onclick="closeModal()">ยกเลิก</button>
      <button class="save" onclick="savePet()">บันทึก</button>
    </div>
  </div>
</div>

<script>

/* ========== SUPABASE ========== */
//window.supabase = supabase.createClient(
const { createClient } = supabase;
const supabaseClient = createClient(
  "https://mlftttqcgryduilanvws.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sZnR0dHFjZ3J5ZHVpbGFudndzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNzg2MjksImV4cCI6MjA4NDc1NDYyOX0.hrDgj0rAgxySsxA5ntz43c8Bkr45_eMFSdCdW0DhIuE"
);

async function loginGoogle() {
  const { error } = await supabaseClient.auth.signInWithOAuth({
    provider: "google"
  });

  if (error) {
    alert("Login failed");
    console.error(error);
  }
}

let currentUser = null;

supabaseClient.auth.onAuthStateChange((event, session) => {
  currentUser = session?.user || null;
  updateUI();
});

function updateUI() {
  if (currentUser) {
    console.log("Login แล้ว:", currentUser.email);
  } else {
    console.log("ยังไม่ login");
  }
}
async function logout() {
  const { error } = await supabaseClient.auth.signOut();
  //location.reload();
}





/* ========== MAP ========== */
const map = L.map('map').setView([13.7563,100.5018],13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'© OpenStreetMap'
}).addTo(map);

let clickLatLng = null;

map.on('click', e => {
  clickLatLng = e.latlng;
  openModal();
});

/////////////////////
map.on('click', e => {
  if (!currentUser) {
    alert("กรุณา Login ด้วย Google ก่อนปักหมุด");
    //loginGoogle();
	closeModal()
    return;
  }

  clickLatLng = e.latlng;
  openModal();
});

/* ========== MODAL ========== */
function openModal(){
  document.getElementById('petModal').classList.add('show');
}
function closeModal(){
  document.getElementById('petModal').classList.remove('show');
}
function toggleOtherAnimal(){
  const v = document.getElementById('animal').value;
  document.getElementById('otherAnimalField').style.display =
    v === 'other' ? 'block' : 'none';
}

/* ========== SAVE ========== */
async function savePet(){
  if(!clickLatLng) return;

  const animalSel = document.getElementById('animal').value;
  const animal =
    animalSel === 'other'
      ? document.getElementById('otherAnimal').value
      : animalSel;

  /* ===== UPLOAD IMAGE ===== */
  let imageUrl = null;
  const fileInput = document.getElementById('imageFile');
  const file = fileInput.files[0];

  if(file){
    const ext = file.name.split('.').pop();
    const fileName = `${Date.now()}.${ext}`;

    const { error: uploadError } = await supabaseClient
      .storage
      .from('pets')
      .upload(fileName, file);

    if(uploadError){
      alert("อัปโหลดรูปไม่สำเร็จ");
      console.error(uploadError);
      return;
    }

    const { data } = supabaseClient
      .storage
      .from('pets')
      .getPublicUrl(fileName);

    imageUrl = data.publicUrl;
  }

  /* ===== SAVE TO DB ===== */
  /*const pet = {
    type: document.getElementById('type').value,
    animal,
    name: document.getElementById('petName').value,
    breed: document.getElementById('breed').value,
    color: document.getElementById('color').value,
    date: document.getElementById('date').value,
    contact: document.getElementById('contact').value,
    image: imageUrl,
    lat: clickLatLng.lat,
    lng: clickLatLng.lng
  };*/
  /* ===== SAVE TO DB ===== */
  const today = new Date().toISOString().split('T')[0];
  const pet = {
    type: document.getElementById('type').value,          // สถานะ
    animal: animal,                                      // สัตว์
    name: document.getElementById('petName').value,      // ชื่อสัตว์
    breed: document.getElementById('breed').value,       // สายพันธุ์
    color: document.getElementById('color').value,       // สี
    date: document.getElementById('date').value || today,         // วันที่
    contact: document.getElementById('contact').value,   // ติดต่อ
	detail: document.getElementById('animalDetail').value,   // ข้อมูลเพิ่มเติม
    image: imageUrl,       // รูป URL
    lat: clickLatLng.lat,
    lng: clickLatLng.lng,
	user_id: currentUser.id
  };

  const { error } = await supabaseClient
    .from("pets")
    .insert([pet]);

  if(error){
    alert("บันทึกไม่สำเร็จ");
    console.error(error);
    return;
  }

  addMarker(pet);
  closeModal();
}

/* ========== LOAD ========== */
async function loadPets(){
  const { data, error } = await supabaseClient
    .from("pets")
    .select("*");

  if(error){
    console.error(error);
    return;
  }

  data.forEach(addMarker);
}

/*function addMarker(pet){
  const iconUrl =
    pet.type === "found"
      ? "https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png"
      : "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png";

  const icon = L.icon({
    iconUrl,
    iconSize:[32,32],
    iconAnchor:[16,32]
  });

  //L.marker([pet.lat, pet.lng], { icon })
  //  .addTo(map)
  //  .bindPopup(`
  //    <b>${pet.name} (${pet.type})</b><br>
  //    สัตว์: ${pet.animal}<br>
  //    สี: ${pet.color}<br>
  //    ติดต่อ: ${pet.contact}
  //  `);
  L.marker([pet.lat, pet.lng],{icon})
    .addTo(map)
    .bindPopup(`
      <b>${pet.name} (${pet.type})</b><br>
      สัตว์: ${pet.animal}<br>
      สายพันธุ์: ${pet.breed}<br>
      สี: ${pet.color}<br>
      วันที่: ${pet.date}<br>
      ติดต่อ: ${pet.contact}<br>
      ${pet.image ? `<img src="${pet.image}" style="width:100%;border-radius:8px;margin-top:6px">` : ''}
    `);
	//${pet.image ? `<img src="${pet.image}" width="150">` : ""}
	
    //.openPopup();
}*/
/*
function addMarker(pet) {
  const icon = createPetIcon(pet);

  L.marker([pet.lat, pet.lng], { icon })
    .addTo(map)
    .bindPopup(`
		<div>
        <b>${pet.name} (${pet.type})</b><br>
		  สัตว์: ${pet.animal}<br>
		  สายพันธุ์: ${pet.breed}<br>
		  สี: ${pet.color}<br>
		  วันที่: ${pet.date}<br>
		  ติดต่อ: ${pet.contact}<br>
		  ${pet.image ? `<img src="${pet.image}" style="width:100%;border-radius:8px;margin-top:6px">` : ''}
		</div>
    `);
}*/
function addMarker(pet) {
  const icon = createPetIcon(pet);

  L.marker([pet.lat, pet.lng], { icon })
    .addTo(map)
    .bindPopup(`
		<div class="popup">
			<div class="popup-img-wrap">
				<img src="${pet.image}" class="popup-img">
			</div>
			
			<div class="popup-info">
			<b>[${pet.type}]</b><br>
			  PetID: ${pet.petID}<br>
			  ชื่อ: ${pet.name}<br>
			  สัตว์: ${pet.animal}<br>
			  สายพันธุ์: ${pet.breed}<br>
			  สี: ${pet.color}<br>
			  วันที่: ${pet.date}<br>
			  ติดต่อ: ${pet.contact}<br>
			  ข้อมูลเพิ่มเติม: ${pet.detail}<br>
			</div>
		</div>
    `);
}

/* ========== PetIcon ========== */
function createPetIcon(pet) {
  return L.icon({
    iconUrl: pet.image || 'icons/paw.png',
    iconSize: [42, 42],
    iconAnchor: [21, 42],
    popupAnchor: [0, -42],
    className: `pet-marker ${pet.type}` // lost / found
  });
}



loadPets();
</script>


</body>
</html>
