<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Find my Pet</title>

<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" sizes="192x192" href="icon-192.png">
<link rel="icon" sizes="512x512" href="icon-512.png">

<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<div id="authBar" class="auth-bar">
  <button id="loginBtn" onclick="loginGoogle()">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏î‡πâ‡∏ß‡∏¢ Google</button>

  <div id="userBox" class="user-box" style="display:none">
    <img id="userAvatar" class="avatar">
    <span id="userName"></span>
    <button onclick="logout()">‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ó‡πå</button>
  </div>
</div>

<div id="marker-shortcut"></div>

<style>
  body { margin:0; font-family: system-ui, sans-serif; }
  
  #map { height:100vh; }


/*------------Add From---------------*/
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    z-index: 1000;

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° */
    padding: 12px;
    overflow-y: auto;   /* ‚≠ê ‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏ô‡∏à‡∏≠ */
  }

  .modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (max-width: 600px) {
    .modal-box {
      max-width: none;
      width: 100%;
      height: 100%;
      max-height: none;
      border-radius: 0;
    }
  }

  .field { margin-bottom:10px; }
  
  label {
  display: inline-block;
  padding: 4px 10px;
  background: #e9ecef;
  color: #000;
  border-radius: 2000px; /* pill */
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 6px;
  }
  
  input, select {
    width:100%;
    padding:8px;
	font-size: 14px;
    border-radius:8px;
    border:1px solid #ccc;
  }

  .actions { display:flex; gap:8px; margin-top:10px; }
  button {
    flex:1;
    padding:10px;
    border:none;
    border-radius:10px;
    cursor:pointer;
  }
  .save { background:#ff5b5b; color:#fff; }
/*----------------------------*/  
  
/*----------------------------*/
.pet-marker {
  position: relative;
  width: 46px;
  height: 46px;
}

/* ‡∏õ‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô */
.pet-marker .day-label {
  position: absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 5;

  background: #e53935;
  color: #fff;
  font-size: 12px;
  font-weight: bold;
  padding: 2px 7px;
  border-radius: 6px;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(0,0,0,.3);
}

/* ‡∏ß‡∏á‡∏£‡∏π‡∏õ */
.pet-avatar {
  width: 46px;
  height: 46px;

  border-radius: 50%;
  overflow: hidden;        /* ‚≠ê ‡∏ï‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏π‡∏õ */
  background: white;
  border: 3px solid #4caf50;

  display: flex;
  align-items: center;
  justify-content: center;
}

.pet-marker.‡∏ï‡∏≤‡∏°‡∏´‡∏≤-Lost .pet-avatar {
  border-color: #e53935;
}
.pet-marker.‡∏û‡∏ö-Found .pet-avatar {
  border-color: #4caf50;
}
.pet-marker.‡∏ï‡∏≤‡∏°‡∏´‡∏≤-Lost .day-label {
  background: #e53935;
}
.pet-marker.‡∏û‡∏ö-Found .day-label {
  background: #4caf50;
}

.pet-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}


/*----------------------------*/

/*-- Popup Pet Informaiom --*/
  .popup {
    width: 300px;
  }

  .popup-img-wrap {
    width: 100%;
    height: 140px;        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÑ‡∏î‡πâ */
    overflow: hidden;    /* ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å */
    border-radius: 12px;
    margin-bottom: 6px;
  }

  .popup-img {
    width: 100%;
    height: 100%;
    object-fit: cover;   /* ‡∏Ñ‡∏£‡∏≠‡∏õ ‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏î */
    display: block;
  }
/*----------------------------*/
  
/*-- login button --*/
.auth-bar {
  position: fixed;
  top: 10px;
  right: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 1000;
}

.user-box {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #fff;
  padding: 6px 10px;
  border-radius: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

.avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
}

button {
  border: none;
  padding: 6px 10px;
  border-radius: 14px;
  cursor: pointer;
}
/*----------------------------*/

/*-- Location Button Style --*/
.loc-btn {
  background: #fff;
  border: none;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  font-size: 30px;
  box-shadow: 0 4px 10px rgba(0,0,0,.25);
}
.leaflet-bottom.leaflet-right .loc-btn {
  margin-bottom: 60px;
  margin-right: 20px;
}    
/*----------------------------*/

/*-- add pet header --*/
  .modal-box h2 {
  display: inline-block;
  background: #FFE412;
  color: #e65100;
  padding: 6px 14px;
  border-radius: 12px;
  font-size: 20px;
  font-weight: 600;
  }
/*----------------------------*/   

/*-- close popup button --*/
  .close-btn {
  background: #999;
  color: #fff;
  }
  
/*-- disable X popup --*/
  .leaflet-popup-close-button {
  display: none;
}
  
.copy-btn {
  background: #999;
  color: #fff;
}  

.preview-container {
  display: flex;
  gap: 6px;
  margin-top: 6px;
  flex-wrap: wrap;
}

.preview-container img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 8px;
  border: 1px solid #ccc;
}

#marker-shortcut {
  position: fixed;
  bottom: 60px;
  left: 20px;
  display: flex;
  flex-direction: column-reverse; /* ‡∏î‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô */
  gap: 10px;
  z-index: 1000;
}

.marker-btn {
  width: 50px;
  height: 50px;
  padding: 2px;
  border-radius: 50%;
  background: white;
}

.marker-btn img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
}
  
</style>
</head>

<body>
<div id="map"></div>

<!-- ===== Modal ===== -->
<div class="modal" id="petModal">
  <div class="modal-box">
    <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</h2>

    <div class="field">
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      <select id="type">
        <option value="‡∏ï‡∏≤‡∏°‡∏´‡∏≤-Lost">‡∏ï‡∏≤‡∏°‡∏´‡∏≤</option>
        <option value="‡∏û‡∏ö-Found">‡∏û‡∏ö</option>
      </select>
    </div>

    <div class="field">
      <label>‡∏™‡∏±‡∏ï‡∏ß‡πå</label>
      <select id="animal" onchange="toggleOtherAnimal()">
        <option value="‡∏™‡∏∏‡∏ô‡∏±‡∏Ç(Dog)">‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
        <option value="‡πÅ‡∏°‡∏ß(Cat)">‡πÅ‡∏°‡∏ß</option>
        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ(Other)">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>
    </div>

    <div class="field" id="otherAnimalField" style="display:none">
      <label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏™‡∏±‡∏ï‡∏ß‡πå</label>
      <input id="otherAnimal" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏Å / ‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢ / ‡πÄ‡∏ï‡πà‡∏≤">
    </div>

	<div class="field">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</label>
      <input id="petName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ö‡πÇ‡∏ö‡πâ / ‡∏°‡∏∞‡∏•‡∏¥">
    </div>

    <div class="field">
      <label>‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</label>
      <input id="breed" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏ó‡∏¢‡∏ú‡∏™‡∏°">
    </div>

    <div class="field">
      <label>‡∏™‡∏µ</label>
      <input id="color" placeholder="‡∏Ç‡∏≤‡∏ß / ‡∏î‡∏≥ / ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•">
    </div>

    <div class="field">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="date">
    </div>

    <div class="field">
      <label>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
      <input id="contact" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ / LINE">
    </div>
<!-- ===== Modal ===== --
    <div class="field">
	  <label>‡∏£‡∏π‡∏õ‡∏™‡∏±‡∏ï‡∏ß‡πå</label>
	  <input type="file" id="imageFile" accept="image/jpeg, image/png">
	</div>
	-->
	<div class="field">
	  <label>‡∏£‡∏π‡∏õ‡∏™‡∏±‡∏ï‡∏ß‡πå (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏£‡∏π‡∏õ)</label>
	  <input
	  type="file"
	  id="images"
	  accept="image/*"
	  multiple
	  >
      <div id="imagePreview" class="preview-container"></div>
    </div>
	
	<div class="field">
	  <label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
	  <input id="animalDetail" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
	</div>

    <div class="actions">
      <button class="cancel" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="save" onclick="savePet()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<script>

/* ========== Protect uploadImages <5 ========== */
const imageInput = document.getElementById('images');
const preview = document.getElementById('imagePreview');

imageInput.addEventListener('change', () => {
  preview.innerHTML = '';

  const files = Array.from(imageInput.files);

  if (files.length > 5) {
    alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏£‡∏π‡∏õ");
    imageInput.value = '';   // reset
    return;
  }

  files.forEach(file => {
    if (!file.type.startsWith('image/')) return;

    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    preview.appendChild(img);
  });
});
/* ========== uploadImages ========== */
async function uploadImages(files, userId) {
  const urls = [];

  for (const file of files) {
    const ext = file.name.split('.').pop();
    const fileName = `${userId}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;

    const { error } = await supabaseClient
      .storage
      .from('pets')
      .upload(fileName, file);

    if (error) {
      console.error("Upload error:", error);
      continue;
    }

    const { data } = supabaseClient
      .storage
      .from('pets')
      .getPublicUrl(fileName);

    urls.push(data.publicUrl);
  }

  return urls;
}

/* ========== User Location ========== */
function locateUser() {
  if (!navigator.geolocation) {
    alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      map.setView([lat, lng], 17);

      // ‡∏•‡∏ö marker ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      if (window.myLocationMarker) {
        map.removeLayer(window.myLocationMarker);
      }

      window.myLocationMarker = L.circleMarker([lat, lng], {
        radius: 8,
        color: "#1976d2",
        fillColor: "#2196f3",
        fillOpacity: 0.8
      })
        .addTo(map)
        .bindPopup("üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
        .openPopup();
    },
    (err) => {
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ");
      console.error(err);
    },
    { enableHighAccuracy: true }
  );
}

/* ========== SUPABASE ========== */
//window.supabase = supabase.createClient(
const { createClient } = supabase;
const supabaseClient = createClient(
  "https://mlftttqcgryduilanvws.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sZnR0dHFjZ3J5ZHVpbGFudndzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNzg2MjksImV4cCI6MjA4NDc1NDYyOX0.hrDgj0rAgxySsxA5ntz43c8Bkr45_eMFSdCdW0DhIuE"
);

async function loginGoogle() {
  const { error } = await supabaseClient.auth.signInWithOAuth({
    provider: "google",
	options: {
      redirectTo: window.location.origin
    }
  });

  if (error) {
    alert("Login failed");
    console.error(error);
  }
}

let currentUser = null;

supabaseClient.auth.onAuthStateChange((event, session) => {
  currentUser = session?.user || null;
  updateUI();
  
  const loginBtn = document.getElementById("loginBtn");
  const userBox = document.getElementById("userBox");

  if (session?.user) {
    const user = session.user;

    loginBtn.style.display = "none";
    userBox.style.display = "flex";

    document.getElementById("userName").textContent =
      user.user_metadata.full_name || user.email;

    document.getElementById("userAvatar").src =
      user.user_metadata.avatar_url || "";
  } else {
    loginBtn.style.display = "inline-block";
    userBox.style.display = "none";
  }
  //console.log("currentUser1:",currentUser);
  Createshortcut(currentUser);
});

function updateUI() {
  if (currentUser) {
    console.log("Login ‡πÅ‡∏•‡πâ‡∏ß:", currentUser.email);
  } else {
    console.log("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà login");
  }
}
async function logout() {
  const { error } = await supabaseClient.auth.signOut();
  //location.reload();
}





/* ========== LOAD MAP ========== */
const map = L.map('map').setView([13.7563,100.5018],13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'¬© OpenStreetMap'
}).addTo(map);
/* ==================== */

/* ========== Click on Map For Post========== */
let clickLatLng = null;

map.on('click', e => {
  clickLatLng = e.latlng;
  openModal();
});
/* ==================== */

/* ========== Can't post if not login ========== */
map.on('click', e => {
  if (!currentUser) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏î‡πâ‡∏ß‡∏¢ Google ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î");
    //loginGoogle();
	closeModal()
    return;
  }

  clickLatLng = e.latlng;
  openModal();
});
/* ==================== */


const locateControl = L.control({ position: "bottomright" });

locateControl.onAdd = () => {
  const btn = L.DomUtil.create("button", "loc-btn");
  btn.innerHTML = "üìç";
  
  // ‚ùó ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ map
  L.DomEvent.disableClickPropagation(btn);
  L.DomEvent.disableScrollPropagation(btn);
  
  //btn.onclick = () => locateUser();
  btn.onclick = function (e) {
    e.preventDefault();
    e.stopPropagation();   // ‚Üê ‡∏Å‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
    locateUser();
  };
  
  
  
  return btn;
};

locateControl.addTo(map);


/* ========== MODAL ========== */
function openModal(){
  document.getElementById('petModal').classList.add('show');
}
function closeModal(){
  document.getElementById('petModal').classList.remove('show');
}
function toggleOtherAnimal(){
  const v = document.getElementById('animal').value;
  document.getElementById('otherAnimalField').style.display =
    v === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ(Other)' ? 'block' : 'none';
}

/* ========== SAVE ========== */
async function savePet(){
  if(!clickLatLng) return;
  
  const { count, error: countError } = await supabaseClient
  .from("pets")
  .select("*", { count: "exact", head: true })
  .eq("user_id", currentUser.id);

  if (countError) {
    alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return;
  }

  if (count >= 3) {
    alert("‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏à‡∏∏‡∏î");
    return;
  }
  
  const animalSel = document.getElementById('animal').value;
  const animal =
    animalSel === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ(Other)'
      ? document.getElementById('otherAnimal').value
      : animalSel;

    const { data: { user } } =
      await supabaseClient.auth.getUser();

    const files = Array.from(
      document.getElementById('images').files
    );

    if (files.length > 5) {
      alert("‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏£‡∏π‡∏õ");
      return;
    }

    const imageUrl = await uploadImages(files, user.id);
	

  /* ===== SAVE TO DB ===== */
  const today = new Date().toISOString().split('T')[0];
  const pet = {
    type: document.getElementById('type').value,          // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    animal: animal,                                      // ‡∏™‡∏±‡∏ï‡∏ß‡πå
    name: document.getElementById('petName').value,      // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå
    breed: document.getElementById('breed').value,       // ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå
    color: document.getElementById('color').value,       // ‡∏™‡∏µ
    date: document.getElementById('date').value || today,         // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    contact: document.getElementById('contact').value,   // ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
	detail: document.getElementById('animalDetail').value,   // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    image: imageUrl,       // ‡∏£‡∏π‡∏õ URL
    lat: clickLatLng.lat,
    lng: clickLatLng.lng,
	//user_name: currentUser.email,
	user_id: currentUser.id
  };

  const { error } = await supabaseClient
    .from("pets")
    .insert([pet]);

  if(error){
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(error);
    return;
  }

  addMarker(pet);
  closeModal();
  loadPets();
}

/* ========== LOAD PET========== */
let loginUser = null;

async function loadPets(){

  const {
  data: { user }
  } = await supabaseClient.auth.getUser()
  loginUser = user;

  const { data, error } = await supabaseClient
    .from("pets")
    .select("*");

  if(error){
    console.error(error);
    return;
  }

  data.forEach(addMarker);
}


const markers = {};
function addMarker(pet) {

  const images = normalizeImages(pet.image);
  //console.log("images:", images[0]);
  //const icon = createPetIcon("https://playgameallday.github.io/paw.png");
  const icon = createPetIcon(pet, images[0]);
  //console.log("icon:", icon);
  
  const gallery = images.map(url => `
  <img
    src="${url}"
    class="popup-thumb"
    onclick="openImage('${url}')"
  >
  `).join('');
  
  let popupHtml = `
    <div class="popup">
      <div class="popup-gallery">
        ${gallery || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ'}
      </div>

      <div class="popup-info">
        <b>[${pet.type}]</b><br>
        PetID: ${pet.petID}<br>
        ‡∏ä‡∏∑‡πà‡∏≠: ${pet.name}<br>
        ‡∏™‡∏±‡∏ï‡∏ß‡πå: ${pet.animal}<br>
        ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå: ${pet.breed}<br>
        ‡∏™‡∏µ: ${pet.color}<br>
        ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${pet.date}<br>
        ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${pet.contact}<br>
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${pet.detail}<br>
  `;

  // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
  if (currentUser && pet.user_id === currentUser.id) {
    popupHtml += `
        <button
         class="delete-btn"
         data-id="${pet.id}"
         style="
         margin-top:8px;
         background:#ff4d4f;
         color:#fff;
         border:none;
         padding:6px 10px;
         border-radius:6px;
         cursor:pointer;
       "
      >
    üóëÔ∏è ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î
        </button>
    `;
  }

  popupHtml += `
        <button class="close-btn" onclick="closePopup()">
          ‚úñ ‡∏õ‡∏¥‡∏î
        </button>
		
		<button class="copy-btn"
          onclick="copyLocation(${pet.lat}, ${pet.lng})">
          üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        </button>
		
      </div>
    </div>
  `;
  
  
   marker = L.marker([pet.lat, pet.lng], { icon })
    .addTo(map)
    .bindPopup(popupHtml);
	
	
  marker.on("popupopen", (e) => {
    const popupEl = e.popup.getElement();
    const btn = popupEl.querySelector(".delete-btn");
    if (!btn) return;

    btn.onclick = () => {
      const petId = btn.dataset.id;
      deletePet(petId);
    };
  });

	
   markers[pet.id] = marker;
}

function normalizeImages(image) {
  if (Array.isArray(image)) return image;

  if (typeof image === "string") {
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON string
    if (image.startsWith("[")) {
      try {
        return JSON.parse(image);
      } catch {
        return [];
      }
    }
    // ‡πÄ‡∏õ‡πá‡∏ô url ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
    return [image];
  }

  return [];
}

/* ========== deletePet ========== */
/*
async function deletePet(petId) {
  if (!petId) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏´‡∏°‡∏∏‡∏î");
    return;
  }
  
  // üî• ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
  const ok = confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ");

  if (!ok) return; // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
  
  const { error } = await supabaseClient
    .from('pets')
    .delete()
    .eq('id', petId)

  if (error) {
    alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + error.message);
	location.reload();
	return;
  } else {
    loadPets();
    alert('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  }

  
  if (markers[petId]) {
    map.removeLayer(markers[petId]);
    delete markers[petId];
  }
  
}
*/
async function deletePet(petId) {

  if (!petId) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏´‡∏°‡∏∏‡∏î");
    return;
  }
  
  // üî• ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
  const ok = confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ");

  if (!ok) return; // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
  
  //if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
  
  

  // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏π‡πâ path ‡∏£‡∏π‡∏õ)
  const { data: pet, error: fetchError } = await supabaseClient
    .from("pets")
    .select("image")
    .eq("id", petId)
    .single();

  if (fetchError) {
    alert("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(fetchError);
    return;
  }

  // 2. normalize ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô array
  const images = normalizeImages(pet.image);

  // 3. ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Storage
  if (images.length > 0) {
    const { error: storageError } = await supabaseClient
      .storage
      .from("pets") // ‚Üê ‡∏ä‡∏∑‡πà‡∏≠ bucket
      .remove(images);

    if (storageError) {
      alert("‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      console.error(storageError);
      return;
    }
  }

  // 4. ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô DB
  const { error: deleteError } = await supabaseClient
    .from("pets")
    .delete()
    .eq("id", petId);
/*
  if (deleteError) {
    alert("‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(deleteError);
    return;
  }
*/  
  if (deleteError) {
    alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + error.message);
	location.reload();
	return;
  } else {
    loadPets();
    alert('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  }

  //alert("‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");

  // 5. ‡∏•‡∏ö marker ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  if (markers[petId]) {
    map.removeLayer(markers[petId]);
    delete markers[petId];
  }
}

/* ========== closePopup ========== */
function closePopup() {
  map.closePopup();
}
/* ========== copyPopup ========== */
function copyLocation(lat, lng) {
  const text = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

  navigator.clipboard.writeText(text)
    .then(() => {
      alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß:\n" + text);
    })
    .catch(() => {
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ");
    });
}


/* ========== PetIcon ========== */
/*
function createPetIcon(pet,image) {
  return L.icon({
    //iconUrl: pet.image?.[0] || pet.image || "paw.png",
	iconUrl: image || "paw.png",
    iconSize: [42, 42],
    iconAnchor: [21, 42],
    popupAnchor: [0, -42],
    className: `pet-marker ${pet.type}` // lost / found
  });
}
*/
function createPetIcon(pet, imageUrl) {
  const days = daysFromDate(pet.date);
  const label = days === 0 ? "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" : `${days} ‡∏ß‡∏±‡∏ô`;

  const html = `
    <div class="pet-marker ${pet.type}">
      <div class="day-label">${label}</div>
      <div class="pet-avatar">
        <img src="${imageUrl || 'paw.png'}">
      </div>
    </div>
  `;

  return L.divIcon({
    html,
    className: "",
    iconSize: [46, 46],
    iconAnchor: [23, 46],
    popupAnchor: [0, -42],
  });
}


function daysFromDate(dateStr) {
  const created = new Date(dateStr);
  const now = new Date();

  created.setHours(0,0,0,0);
  now.setHours(0,0,0,0);

  return Math.floor((now - created) / (1000 * 60 * 60 * 24));
}

function openImage(url) {
  const overlay = document.createElement('div');
  overlay.style = `
    position:fixed; inset:0;
    background:rgba(0,0,0,.85);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
  `;

  overlay.innerHTML = `
    <img src="${url}"
      style="max-width:95%;max-height:95%;border-radius:12px">
  `;

  overlay.onclick = () => overlay.remove();
  document.body.appendChild(overlay);
}

/* ========== Mark shortcut ========== */

function shortcutIcon(iconUrl) {
  return L.icon({
    iconUrl,
    iconSize: [42, 42],
    iconAnchor: [21, 42],
    popupAnchor: [0, -36]
  });
}

async function Createshortcut(currentUser) {
//console.log("currentUser2:",currentUser);
if (currentUser){
//console.log("currentUser3:",currentUser);
const { data: pets, error } = await supabaseClient
  .from("pets")
  .select("id, lat, lng, image, created_at")
  .eq("user_id", currentUser.id)
  .order("created_at", { ascending: false });

if (error) {
  console.error(error);
  return;
}

//const userMarkers = [];   // ‡πÄ‡∏Å‡πá‡∏ö marker leaflet
const userPets = [];     // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å DB


pets.forEach((pet) => {
  /*
  const images2 = normalizeImages(pet.image);
  
  const icon = shortcutIcon(images2[0]);

  const marker = L.marker(
    [pet.lat, pet.lng],
    { icon }
  ).addTo(map);

  userMarkers.push(marker);*/
  userPets.push(pet);
});


const shortcut = document.getElementById("marker-shortcut");
shortcut.innerHTML = "";

userPets.forEach((pet, index) => {
  const btn = document.createElement("div");
  btn.className = "marker-btn";

  const img = document.createElement("img");
  const images2 = normalizeImages(pet.image);

  img.src = images2[0] || "paw.png";

  btn.appendChild(img);

  btn.onclick = () => {
    map.flyTo(
      [pet.lat, pet.lng],
      17,
      { animate: true, duration: 0.8 }
    );
    //userMarkers[index].openPopup?.();
  };

  shortcut.appendChild(btn);
});


}
}

loadPets();
</script>


</body>
</html>
